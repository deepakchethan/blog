<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>The Official Radare Blog  | Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.58.3" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically" />
<meta property="og:description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radare.today/posts/malware-static-analysis/" />
<meta property="article:published_time" content="2016-08-11T08:30:00+01:00" />
<meta property="article:modified_time" content="2016-08-11T08:30:00+01:00" />
<meta itemprop="name" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically">
<meta itemprop="description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity.">


<meta itemprop="datePublished" content="2016-08-11T08:30:00&#43;01:00" />
<meta itemprop="dateModified" content="2016-08-11T08:30:00&#43;01:00" />
<meta itemprop="wordCount" content="663">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically"/>
<meta name="twitter:description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://radare.today" class="f3 fw2 hover-white no-underline white-90 dib">
      The Official Radare Blog
    </a>
    <div class="flex-l items-center">
      

      
      



<a href="radareorg" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2016-08-11T08:30:00&#43;01:00">August 11, 2016</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h1 id="introduction">Introduction</h1>

<p>This article was written during <a href="https://www.bsideslv.org">BSidesLV</a>, <a href="https://www.blackhat.com/">BlackHat</a> and <a href="https://www.defcon.org/">Defcon</a> events.</p>

<p>** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one <a href="https://virustotal.com/en/file/f15985a91b12e015812f7f960eb0abe03d0cd401f54d0088f75cb087776a297c/analysis/">cfd26988d55294870f2676117cf1307ca4acdf8d</a> **</p>

<p>A remote administration tool (also known as a <a href="https://en.wikipedia.org/wiki/Remote_administration_software">RAT</a>) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity. In this example we are going to take a look at <em>Cybergate RAT</em> which have its configuration hardcoded. Our goal is to decrypt and retrieve its configuration.</p>

<p><img src="https://i.imgur.com/q2kML7b.png" alt="Cybergate RAT CnC" /></p>

<h1 id="getting-started">Getting started</h1>

<h2 id="hashing">Hashing</h2>

<p>To get the SHA1 you can use <code>rahash2 -a sha1 sample.exe</code> or <code>ph sha1 $s @ 0</code>. The <code>$s</code> variable contains the binary size, see <code>?$?</code> to get the complete list of variable.</p>

<p><img src="https://i.imgur.com/jJB55rE.png" alt="" /></p>

<p>See also rahash2 tutorial on</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/aMcGrHM-wig" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<h2 id="strings">Strings</h2>

<p>To get the complete list of strings, use
<code>rabin2 -zz sample.exe</code> or <code>[0x0040e1a8]&gt; izz</code>.
You can also get them in json format by appending <code>j</code>, like <code>rabin2 -zzj sample.exe</code> or <code>[0x0040e1a8]&gt; izzj</code>.</p>

<p>You can notice that in the sample there is a huge proportion of <code>###@###</code>. To give you a hint, it is very frequent that basic RAT store their configuration in an encrypted form and use delimiter to seperate the various elements, like <code>###@###http://urlofattacker###@###enableFTP=true###@###</code>. You can also see that this string is stored in the <code>.rsrc.</code> section. If you want more context, you can simply use <code>rafind2 -X -s &quot;###&quot; sample.exe</code>.</p>

<p><img src="https://i.imgur.com/FcQR7hS.png" alt="" /></p>

<h2 id="information-of-the-binary">Information of the binary</h2>

<ul>
<li>Get Information: <code>rabin2 -I sample.exe</code> or <code>[0x0040e1a8]&gt; iI</code></li>
<li>Get Entrypoint: <code>rabin2 -e sample.exe</code> or <code>[0x0040e1a8]&gt; ie</code></li>
<li>Get Sections: <code>rabin2 -S sample.exe</code> or <code>iS</code></li>
<li>Get imports: <code>rabin2 -i sample.exe</code> or <code>[0x0040e1a8]&gt; ii</code></li>
<li>Get libraries: <code>rabin2 -L sample.exe</code> or <code>[0x0040e1a8]&gt; iL</code></li>
<li>Get Entropy: <code>rahash2 -B -b 512 -a entropy sample.exe</code> or <code>[0x0040e1a8]&gt; p=e</code></li>
</ul>

<p>You can of course combine everything into one command: <code>-IeiL</code>.</p>

<p>Imports are giving us an indication about what resource are manipulated, you can get them with <code>rabin2 -i sample.exe</code>, as mentionned previously.</p>

<p><img src="https://i.imgur.com/0ZQqv4j.png" alt="" /></p>

<h1 id="analysis">Analysis</h1>

<p>We want to open and analyse the binary the dumb way <code>r2 -A</code> (-A is using <code>[0x0040e1a8]&gt; aaa</code> see why it is a bad practice here: <a href="http://radare.today/posts/analysis-by-default/">http://radare.today/posts/analysis-by-default/</a>).</p>

<p>We know that the configuration is located in the <code>.rsrc</code> segment. By checking the imports we know that what resources are manipulated: Let see where this takes place by looking at the <em>XREFS</em>.</p>

<p>In the visual mode we can visit <code>VF</code> to get all flags, then go to the <em>hud</em>, using <code>_</code> we can search for <code>LoadResource</code>.</p>

<p><img src="https://i.imgur.com/9jW0kdm.png" alt="" /></p>

<p>If you select <code>imp.kernel32.dll_LoadResource</code>, which appears to be a relocation, <code>x</code> is giving us the xref and we can use <code>0</code> shortcut (keyboard) to seek to the first (and only) reference. We can do it again as it was just a relocation and we land on <code>fcn.0040630c</code>.</p>

<p><img src="https://i.imgur.com/gCPavif.png" alt="" /></p>

<p>We now use visual graph using <code>V</code> don&rsquo;t forget to activate comment using <code>&quot;</code>.</p>

<p>As we can see this function primary purpose is clearly to load the resource. Let&rsquo;s rename it using <code>r</code> (as in <strong>r</strong>ename) followed by <code>get_resource</code>.</p>

<p>Let see the xref of this function. <code>fcn.00406380</code>. We can see that this function is manipulationg <code>###@###</code> in <code>mov edx, 0x406460 ; &quot;####@####&quot; 0x00406460</code>.</p>

<p><img src="https://i.imgur.com/KQfGEZ8.png" alt="" /></p>

<p>If we look at the function called after this using keyboard <code>g</code> followed by the letter in brackets: <code>[a]</code>, <code>[b]</code>.. we can see lot of them looks like garbage but one clearly stand out: .</p>

<p>We can see a loop with a buffer being xored <code>xor dl, 0xbc</code>.</p>

<p><img src="https://i.imgur.com/NRomw6D.png" alt="XOR Routine" /></p>

<h1 id="configuration-decryption">Configuration decryption</h1>

<p>We can now proceed decryption the dirty way. First we reopen the binary in raw + write mode using <code>oonn+</code> then we use <code>wox</code> to xor the binary. <code>[0x0040e1a8]&gt; wox 0xbc $s @ 0</code>. Now relaunching the <code>[0x0040e1a8]&gt; izz</code> we can see the decrypted configuration!</p>

<h1 id="next-steps">Next steps</h1>

<p>If you are looking for Malware RAT Family easy to analyze, please check out <a href="https://github.com/kevthehermit/RATDecoders">RATDecoders</a>.</p>

<p>&ndash; Maxime M., Incident Intelligence Analyst @ FireEye (aka <a href="https://twitter.com/Maijin212">Maijin</a>)</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://radare.today" >
    &copy; 2019 The Official Radare Blog
  </a>
    <div>



<a href="radareorg" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>

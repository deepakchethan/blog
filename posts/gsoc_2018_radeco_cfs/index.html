<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>The Official Radare Blog  | GSoC 2018: Control Flow Structuring for Radeco-lib</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.58.3" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="GSoC 2018: Control Flow Structuring for Radeco-lib" />
<meta property="og:description" content="GSoC 2018: Control Flow Structuring for Radeco-lib Introduction This summer, I implemented the control flow structuring algorithm described in No More Gotos. The algorithm takes a program represented as a control flow graph and converts it into a semantically equivalent program but with all control flow represented with C-like control flow statements (e.g. if-statements, while-loops, etc.) and zero goto statements.
Example bool c0 = test0(); if (!c0) { run1(); } if (c0 &amp;&amp; test2()) { run4(); } else { run3(); } run5();  Algorithm Overview This section is essentially a (very brief) summary of No More Gotos." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radare.today/posts/gsoc_2018_radeco_cfs/" />
<meta property="article:published_time" content="2018-08-12T21:42:12-04:00" />
<meta property="article:modified_time" content="2018-08-12T21:42:12-04:00" />
<meta itemprop="name" content="GSoC 2018: Control Flow Structuring for Radeco-lib">
<meta itemprop="description" content="GSoC 2018: Control Flow Structuring for Radeco-lib Introduction This summer, I implemented the control flow structuring algorithm described in No More Gotos. The algorithm takes a program represented as a control flow graph and converts it into a semantically equivalent program but with all control flow represented with C-like control flow statements (e.g. if-statements, while-loops, etc.) and zero goto statements.
Example bool c0 = test0(); if (!c0) { run1(); } if (c0 &amp;&amp; test2()) { run4(); } else { run3(); } run5();  Algorithm Overview This section is essentially a (very brief) summary of No More Gotos.">


<meta itemprop="datePublished" content="2018-08-12T21:42:12-04:00" />
<meta itemprop="dateModified" content="2018-08-12T21:42:12-04:00" />
<meta itemprop="wordCount" content="733">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GSoC 2018: Control Flow Structuring for Radeco-lib"/>
<meta name="twitter:description" content="GSoC 2018: Control Flow Structuring for Radeco-lib Introduction This summer, I implemented the control flow structuring algorithm described in No More Gotos. The algorithm takes a program represented as a control flow graph and converts it into a semantically equivalent program but with all control flow represented with C-like control flow statements (e.g. if-statements, while-loops, etc.) and zero goto statements.
Example bool c0 = test0(); if (!c0) { run1(); } if (c0 &amp;&amp; test2()) { run4(); } else { run3(); } run5();  Algorithm Overview This section is essentially a (very brief) summary of No More Gotos."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://radare.today" class="f3 fw2 hover-white no-underline white-90 dib">
      The Official Radare Blog
    </a>
    <div class="flex-l items-center">
      

      
      



<a href="radareorg" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">GSoC 2018: Control Flow Structuring for Radeco-lib</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2018-08-12T21:42:12-04:00">August 12, 2018</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h1 id="gsoc-2018-control-flow-structuring-for-radeco-lib">GSoC 2018: Control Flow Structuring for Radeco-lib</h1>

<h2 id="introduction">Introduction</h2>

<p>This summer, I implemented the control flow structuring algorithm described in <a href="https://doi.org/10.14722/ndss.2015.23185"><em>No More Gotos</em></a>. The algorithm takes a program represented as a control flow graph and converts it into a semantically equivalent program but with all control flow represented with C-like control flow statements (e.g. <code>if</code>-statements, <code>while</code>-loops, etc.) and <strong>zero <code>goto</code> statements</strong>.</p>

<h3 id="example">Example</h3>

<p><img src="/images/example_cfg.png" alt="example cfg" /></p>

<pre><code class="language-cpp">bool c0 = test0();
if (!c0) {
    run1();
}
if (c0 &amp;&amp; test2()) {
    run4();
} else {
    run3();
}
run5();
</code></pre>

<h2 id="algorithm-overview">Algorithm Overview</h2>

<p>This section is essentially a (very brief) summary of <em>No More Gotos</em>.
We traverse every node in the graph in post-order. If the current node is the target of a backedge, we&rsquo;re at the head of a loop, so we funnel all entries/exits to a single loop header/successor, structure the loop body, and structure the whole loop. Otherwise, if the set of nodes dominated by the current node has exactly one or zero successors, we structure that region. Otherwise, we just continue the graph traversal.
To structure an acyclic region, we compute the reaching condition for each node, move the whole region to a new graph, perform refinements on that graph, and finally make an AST node containing all the nodes in topological order.
To structure a loop, we repeatedly apply a set of rewrite rules to the loop body&rsquo;s AST until no more apply.
To funnel abnormal loop entries/exits, we first associate a number to each node that has an incoming abnormal edge. We then introduce a structuring variable and redirect each node&rsquo;s incoming abnormal edges to a new node that assigns the value we associated with that node to the structuring variable. We connect these new nodes to a condition cascade that checks the value of the structuring variable and directs control flow to the appropriate destination.</p>

<h2 id="implementation-overview">Implementation Overview</h2>

<p>All of the code for this algorithm lives in <code>backend::ctrl_flow_struct</code>. The correctness-critical parts live in the main module and the refinements live in the submodule <code>refinement</code>. <code>condition</code> contains the implementation of conditions; in particular it contains the code to simplify conditions which is necessary for <code>refinement</code> to be able to do anything useful. All of the code is generic over the particular concrete AST implementation; all operations on the underlying AST (such as introducing new assignment statements) are done through the trait <code>ast_context::AstContextMut</code>.
The code that interfaces between this algorithm and the rest of the decompiler lives in the modules <code>backend::lang_c::c_cfg::ctrl_flow_struct</code> and <code>backend::ctrl_flow_struct::export</code>.</p>

<h2 id="further-improvements">Further improvements</h2>

<ul>
<li>There could be options to switch off various refinements.</li>
<li>Loop membership/successor refinement could be tweakable by the user (and could be moved to the <code>refinement</code> module).</li>
<li>Conditions <em>should</em> probably be interned (like types in rustc). That way, comparing two conditions for equality can be done by a single pointer comparison instead of walking the whole expression graph.</li>
<li>The algorithm will never produce a <code>continue</code> statements or a labeled <code>break</code> or <code>continue</code> statement. There are probably cases where using these would make the output simpler.</li>

<li><p>The semantic model for conditions in condition nodes in control flow graphs (as described in the paper) appears to be &ldquo;a pure predicate on the program state evaluated when control flow enters the node&rdquo;. However, this is obviously violated when we effectively &ldquo;sink&rdquo; conditions to each node during acyclic region structuring. Condition-based refinement appears to partly resolve this by &ldquo;rehoisting&rdquo; repeated conditions into bigger <code>if</code>-statements, but that doesn&rsquo;t happen for all conditions. The paper briefly touches on this problem (section IV.D on pg. 9), but the authors never conclusively show that these semantics are preserved.</p>

<ul>
<li>This could be fixed by having the algorithm convert every condition node into an assignment of its value to a boolean variable and using only that variable in the reaching conditions. There would also need to be a pass that inlines that variable when appropriate.</li>

<li><p>Also, there exist cases where conditions in the output AST are evaluated &ldquo;eagerly&rdquo; (i.e. before they &ldquo;should&rdquo; be evaluated according to the control flow graph). <a href="https://hackmd.io/x_lOEIIyR9etkCecbpLFeg#">example</a></p>

<h1 id="some-other-things-i-also-did">Some Other Things I Also Did</h1></li>
</ul></li>

<li><p>(before GSoC) <a href="https://github.com/radareorg/radeco-lib/pull/126">Implemented a parser for textual IR</a></p></li>

<li><p><a href="https://github.com/HMPerson1/radeco-csmith-tester">Made a test driver for <code>radeco-lib</code> that we never got around to using</a></p></li>

<li><p><a href="https://github.com/radareorg/radeco-lib/pull/140">Added a pass that determines how a function uses each register and also a pass that turns <code>(x+4)-4</code> into <code>x+0</code> and then into <code>x</code> all in the same pull request for some reason</a></p></li>

<li><p><a href="https://github.com/radareorg/radeco-lib/pull/194">Brutally annihilated the dependency on capstone</a></p>

<h1 id="links">Links</h1></li>

<li><p><a href="https://summerofcode.withgoogle.com/projects/#4679353015730176">GSoC project page</a></p></li>

<li><p><a href="https://github.com/radareorg/radeco-lib/pulls?q=is%3Apr+author%3AHMPerson1+created%3A2018-05-01..2018-08-14">Pull Requests</a></p></li>

<li><p><a href="https://github.com/radareorg/radeco-lib/commits?author=HMPerson1&amp;since=2018-05-01&amp;until=2018-08-14">Commits</a></p></li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://radare.today" >
    &copy; 2019 The Official Radare Blog
  </a>
    <div>



<a href="radareorg" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
